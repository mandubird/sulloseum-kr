# 썰로세움 자동 발행 구현 요약

배틀 결과를 쇼츠 영상으로 만들고, YouTube Shorts / TikTok / X 업로드 직전까지 자동 입력하는 기능 요약 및 실행 방법입니다.

---

## 1. 구현된 내용

### 1) 배틀 페이지 – 녹화 모드 (`?record=1`)

- **파일:** `app/battle/[battleId]/page.tsx`
- URL에 `?from=board&record=1` 붙이면:
  - 재생을 처음부터 시작 (`replayStep` 0)
  - 대사가 약 2.8초 간격으로 자동 진행
  - 전체 보기 후 결과 영역 자동 펼침
  - 끝나면 `ssulo:record-ready` 이벤트 발생 → 스크립트가 “녹화 완료” 시점으로 사용
- 녹화 모드에서는 “다음 대사/전체보기” 버튼, “결과보기” 접기 버튼, 하단 푸터는 숨김

### 2) 영상 생성 스크립트

- **파일:** `scripts/render-battle-video.ts`
- Playwright로 1080×1920 뷰포트에서 `?from=board&record=1` URL을 열고 녹화
- `ssulo:record-ready` 나올 때까지 대기 후 저장
- **결과:** `outputs/videos/<battleId>.webm`, `outputs/metadata/<battleId>.json`

### 3) 캡션/메타 생성 스크립트

- **파일:** `scripts/prepare-publish.ts`
- Supabase에서 배틀·에이전트 정보를 가져와 YouTube / TikTok / X용 제목·설명·캡션·해시태그 생성
- **결과:** `outputs/metadata/<battleId>-publish.json`

### 4) 업로드 세션 스크립트

- **파일:** `scripts/open-publish-session.ts`, `scripts/publish-selectors.ts`
- 브라우저를 띄운 뒤 YouTube Studio / TikTok 업로드 / X 포스트 작성 탭을 열고, 메타 파일·영상으로 입력 시도
- **최종 게시는 사용자가 직접 클릭**

### 5) 기타

- **outputs:** `outputs/videos`, `outputs/metadata`, `outputs/reports` 폴더 생성 (`.gitkeep` 포함)
- **.gitignore:** `outputs/videos/*.webm`, `*.mp4`, `outputs/metadata/*.json` 추가
- **package.json:** `render-video`, `prepare-publish`, `open-publish` 스크립트 추가

---

## 2. 어떻게 실행하는지

### 사전 준비 (최초 1회 또는 환경 세팅 시)

1. **프로젝트 폴더로 이동**
   ```bash
   cd /Users/gimmingyu/Desktop/2025/Sulloseum_KR
   ```

2. **Chromium 설치 (영상 녹화용)**
   ```bash
   npx playwright install chromium
   ```

3. **서버**  
   **배포 서버 기준**이면 로컬에서 `npm run dev` 를 켤 필요 없습니다. 영상 생성 시 명령어에 `https://www.ssulo.com` 을 넣으면 배포된 사이트에서 재생을 불러와 녹화합니다.

4. **캡션 생성용 환경 변수**  
   `prepare-publish` 를 쓰려면 프로젝트 루트에 `.env.local` 이 있고, 다음이 있어야 합니다.
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`

---

### 실행 순서 (배틀 1건 기준) — **배포된 서버 기준**

**기준:** 배틀 페이지는 **배포된 사이트(https://www.ssulo.com)** 에서 불러옵니다. 로컬에서 `npm run dev` 를 켜 둘 필요 없습니다.

**완료된 배틀**의 `battleId`가 있어야 합니다. (게시판에서 배틀 들어가서 URL의 `/battle/xxxx` 에서 `xxxx` 부분)

#### ① 영상 생성

```bash
npm run render-video -- <battleId> https://www.ssulo.com
```

- **배포 기준이면 `baseUrl` 을 꼭 넣으세요.** 안 넣으면 기본값이 localhost 라서 실패할 수 있습니다.
- 예: `npm run render-video -- abc123 https://www.ssulo.com`

**결과:** `outputs/videos/<battleId>.webm` 생성

---

#### ② 캡션/메타 생성

```bash
npm run prepare-publish -- <battleId> https://www.ssulo.com
```

- 예: `npm run prepare-publish -- abc123 https://www.ssulo.com`  
- `baseUrl` 생략 시 기본값이 `https://www.ssulo.com` 이라서, `npm run prepare-publish -- abc123` 만 쳐도 됩니다.

**결과:** `outputs/metadata/<battleId>-publish.json` 생성 (YouTube/TikTok/X용 제목·설명·캡션)

---

#### ③ 업로드 화면까지 자동 입력

```bash
npm run open-publish -- <battleId>
```

- 예: `npm run open-publish -- abc123`
- 브라우저가 열리고 YouTube / TikTok / X 탭에 제목·캡션·영상 입력을 시도합니다.
- **게시 버튼은 직접 눌러야 합니다.**

---

### 한 번에 복사해서 쓸 수 있는 예시 (배포 서버 기준)

`battleId` 를 실제 값으로 바꾼 뒤 터미널에 붙여넣기 하면 됩니다.

```bash
# 1) 영상 생성 (배포 서버에서 재생 녹화)
npm run render-video -- 여기에_배틀ID_입력 https://www.ssulo.com

# 2) 캡션 생성
npm run prepare-publish -- 여기에_배틀ID_입력 https://www.ssulo.com

# 3) 업로드 화면 열기
npm run open-publish -- 여기에_배틀ID_입력
```

---

## 3. 문제 발생 시

| 상황 | 확인/해결 |
|------|-----------|
| `영상 생성` 시 페이지가 안 열림 | 서버가 떠 있는지 확인 (`npm run dev` 또는 배포 URL). `baseUrl` 이 맞는지 확인. |
| `영상 생성` 시 재생이 안 끝남 | 해당 배틀이 **완료 상태**인지 확인. `?from=board&record=1` 로 직접 접속해서 자동 재생되는지 확인. |
| `캡션 생성` 시 에러 | `.env.local` 에 Supabase URL/키가 있는지 확인. 해당 `battleId` 가 DB에 있는지 확인. |
| `업로드 화면` 에서 입력이 안 됨 | YouTube/TikTok/X UI가 바뀌었을 수 있음. `scripts/publish-selectors.ts` 의 셀렉터를 해당 사이트에 맞게 수정. |

---

## 4. 관련 파일 위치

| 용도 | 경로 |
|------|------|
| 녹화 모드 UI | `app/battle/[battleId]/page.tsx` |
| 영상 생성 | `scripts/render-battle-video.ts` |
| 캡션/메타 생성 | `scripts/prepare-publish.ts` |
| 업로드 화면 열기 | `scripts/open-publish-session.ts` |
| 플랫폼 셀렉터 (수정용) | `scripts/publish-selectors.ts` |
| 산출물 폴더 | `outputs/videos`, `outputs/metadata`, `outputs/reports` |
| 상세 계획/일정 | `자동_발행_개발_계획서.md` |
